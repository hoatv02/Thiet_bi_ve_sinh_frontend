<div class="p-6 bg-white rounded-xl shadow-sm border">
  <!-- Header -->
  <div class="flex justify-between items-center mb-6">
    <div>
      <h1 class="text-xl font-bold text-gray-700">Th√™m m·ªõi s·∫£n ph·∫©m</h1>
      <p class="text-sm text-gray-500">Qu·∫£n l√Ω s·∫£n ph·∫©m / Th√™m m·ªõi s·∫£n ph·∫©m</p>
    </div>
    <button (click)="goBack()" class="text-sm text-gray-500 hover:text-gray-700 flex items-center space-x-1">
      <lucide-icon name="arrow-left" class="w-4 h-4"></lucide-icon>
      <span>Quay l·∫°i</span>
    </button>
  </div>

  <!-- Form ch√≠nh -->
  <form (ngSubmit)="saveProduct()" class="grid grid-cols-2 gap-8">
    <!-- C·ªôt tr√°i (2/3) -->
    <div class="col-span-1 space-y-3">
      <div class="grid grid-cols-2 gap-2">
        <!-- ID -->
        <div>
          <label class="block text-sm text-gray-600 mb-1">ID s·∫£n ph·∫©m</label>
          <input type="text" [(ngModel)]="product.sku" name="id" placeholder="Nh·∫≠p m√£ s·∫£n ph·∫©m"
            class="w-full border rounded-md px-3 py-2 text-sm focus:ring-1 focus:ring-orange-400" />
        </div>

        <!-- T√™n -->
        <div>
          <label class="block text-sm text-gray-600 mb-1">T√™n s·∫£n ph·∫©m *</label>
          <input type="text" [(ngModel)]="product.name" name="name" required placeholder="Nh·∫≠p t√™n s·∫£n ph·∫©m"
            class="w-full border rounded-md px-3 py-2 text-sm focus:ring-1 focus:ring-orange-400" />
        </div>
        <!-- Danh m·ª•c -->
        <div>
          <label class="block text-sm text-gray-600 mb-1">Danh m·ª•c s·∫£n ph·∫©m *</label>
          <select [(ngModel)]="product.typeId" name="categoryId" required (ngModelChange)="getCate($event)"
            class="w-full border rounded-md px-3 py-2 text-sm focus:ring-1 focus:ring-orange-400">
            <option value="">Ch·ªçn danh m·ª•c s·∫£n ph·∫©m</option>
            <option *ngFor="let t of types" [ngValue]="t.id">{{ t.name }}</option>
          </select>
        </div>

        <!-- Lo·∫°i -->
        <div>
          <label class="block text-sm text-gray-600 mb-1">Lo·∫°i s·∫£n ph·∫©m *</label>
          <select [(ngModel)]="product.categoryId" name="typeId" required
            class="w-full border rounded-md px-3 py-2 text-sm focus:ring-1 focus:ring-orange-400">
            <option value="">Ch·ªçn lo·∫°i s·∫£n ph·∫©m</option>
            <option *ngFor="let c of categories" [ngValue]="c.id">{{ c.name }}</option>
          </select>
        </div>

        <!-- Th∆∞∆°ng hi·ªáu -->
        <div>
          <label class="block text-sm text-gray-600 mb-1">Th∆∞∆°ng hi·ªáu</label>
          <select [(ngModel)]="product.brandId" name="brandId"
            class="w-full border rounded-md px-3 py-2 text-sm focus:ring-1 focus:ring-orange-400">
            <option value="">Ch·ªçn th∆∞∆°ng hi·ªáu</option>
            <option *ngFor="let b of brands" [ngValue]="b.id">{{ b.name }}</option>
          </select>
        </div>


        <!-- Gi√° -->
        <div>
          <label class="block text-sm text-gray-600 mb-1">Gi√° th√†nh (VND)</label>
          <!-- <input type="number" [(ngModel)]="product.price" name="price" placeholder="Nh·∫≠p gi√° th√†nh"
            class="w-full border rounded-md px-3 py-2 text-sm focus:ring-1 focus:ring-orange-400" /> -->
          <input type="text" [ngModel]="formatPrice(product.price)" (ngModelChange)="onProductPriceChange($event)"
            name="price" placeholder="Nh·∫≠p gi√° th√†nh"
            class="w-full border rounded-md px-3 py-2 text-sm focus:ring-1 focus:ring-orange-400" />
        </div>

        <!-- üí∏ Gi·∫£m gi√° (%) -->
        <div>
          <label class="block text-sm text-gray-600 mb-1">Gi·∫£m gi√° (%)</label>
          <input type="number" [(ngModel)]="product.discountPercent" name="DiscountPercent"
            placeholder="Nh·∫≠p % gi·∫£m (0-100)" min="0" max="100"
            class="w-full border rounded-md px-3 py-2 text-sm focus:ring-1" (input)="updateDiscountedPrice()" />

          <p class="text-xs text-gray-500 mt-1" *ngIf="product.salePrice > 0">
            üí∞ Gi√° sau gi·∫£m:
            <span class="font-semibold text-green-600">{{ product.salePrice | number:'1.0-0':'vi' }} VND</span>
          </p>
        </div>

        <!-- S·ªë l∆∞·ª£ng -->
        <div>
          <label class="block text-sm text-gray-600 mb-1">S·ªë l∆∞·ª£ng s·∫£n ph·∫©m</label>
          <input type="number" [(ngModel)]="product.stockQuantity" name="quantity" placeholder="Nh·∫≠p s·ªë l∆∞·ª£ng"
            class="w-full border rounded-md px-3 py-2 text-sm focus:ring-1 focus:ring-orange-400" />
        </div>

        <!-- Tr·∫°ng th√°i -->
        <div>
          <label class="block text-sm text-gray-600 mb-1">Tr·∫°ng th√°i s·∫£n ph·∫©m</label>

          <select name="isActive" [(ngModel)]="product.isActive"
            class="w-full border rounded-md px-3 py-2 text-sm focus:ring-1">
            <option [ngValue]="null">Ch·ªçn</option>
            <option [ngValue]="1">ƒêang b√°n</option>
            <option [ngValue]="0">Ng·ª´ng b√°n</option>
          </select>
        </div>
        <!-- ‚úÖ 3 LINK T√ÄI LI·ªÜU (full grid column, n·∫±m d∆∞·ªõi Tr·∫°ng th√°i) -->
        <div class="col-span-2">
          <label class="block text-sm text-gray-600 mb-1">Link th√¥ng s·ªë k·ªπ thu·∫≠t</label>
          <input type="url" [(ngModel)]="product.warrantyInfo" name="warrantyInfo"
            placeholder="https://... (link th√¥ng s·ªë k·ªπ thu·∫≠t)"
            class="w-full border rounded-md px-3 py-2 text-sm focus:ring-1" />
        </div>

        <div class="col-span-2">
          <label class="block text-sm text-gray-600 mb-1">Link h∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</label>
          <input type="url" [(ngModel)]="product.deliveryInfo" name="deliveryInfo"
            placeholder="https://... (link h∆∞·ªõng d·∫´n s·ª≠ d·ª•ng)"
            class="w-full border rounded-md px-3 py-2 text-sm focus:ring-1" />
        </div>
        <div class="col-span-2">
          <label class="block text-sm text-gray-600 mb-1">Link h∆∞·ªõng d·∫´n l·∫Øp ƒë·∫∑t</label>
          <input type="url" [(ngModel)]="product.installationSupport" name="installationSupport"
            placeholder="https://... (link h∆∞·ªõng d·∫´n l·∫Øp ƒë·∫∑t)"
            class="w-full border rounded-md px-3 py-2 text-sm focus:ring-1" />
        </div>
      </div>

      <!-- Gi·ªõi thi·ªáu -->
      <div>
        <label class="block text-sm text-gray-600 mb-1">Gi·ªõi thi·ªáu v·ªÅ s·∫£n ph·∫©m *</label>
        <ckeditor [(ngModel)]="product.description" name="description" [editor]="Editor" data="" [config]="{
        placeholder: 'Nh·∫≠p n·ªôi dung gi·ªõi thi·ªáu s·∫£n ph·∫©m...',
        toolbar: [
          'heading', '|', 'bold', 'italic', 'link', 'bulletedList', 'numberedList', '|',
          'blockQuote', 'undo', 'redo'
          ]
        }"></ckeditor>
      </div>
    </div>

    <!-- C·ªôt ph·∫£i (1/3) -->
    <div>
      <label class="block text-sm text-gray-600 mb-2">·∫¢nh s·∫£n ph·∫©m</label>

      <!-- ·∫¢NH CH√çNH -->
      <div
        class="border-2 border-dashed rounded-lg p-6 text-center text-gray-500 hover:bg-gray-50 cursor-pointer h-[340px] flex flex-col justify-center relative"
        (click)="fileInputMain.click()">
        <ng-container *ngIf="!previewMain; else mainPreviewBlock">
          <lucide-icon name="upload-cloud" class="w-10 h-10 mx-auto mb-2"></lucide-icon>
          <p>
            K√©o th·∫£ ·∫£nh ho·∫∑c <span class="text-[#3AA7E9] underline">Ch·ªçn file</span> ƒë·ªÉ t·∫£i l√™n
          </p>
          <p class="text-xs text-gray-400 mt-1">(T·ªëi ƒëa 10MB, ƒë·ªãnh d·∫°ng .jpg .png)</p>
        </ng-container>

        <ng-template #mainPreviewBlock>
          <img [src]="previewMain" alt="·∫¢nh ch√≠nh" class="w-full h-full object-contain rounded-md" />
          <button type="button" (click)="removeMain($event)"
            class="absolute top-2 right-2 bg-white/90 hover:bg-white text-gray-600 rounded-full p-1 shadow-sm">
            <lucide-icon name="x" class="w-4 h-4"></lucide-icon>
          </button>
        </ng-template>
      </div>
      <input type="file" hidden #fileInputMain (change)="onMainSelected($event)" accept="image/*" />

      <!-- ·∫¢NH GALLERY -->
      <div class="mt-4">
        <label class="block text-sm text-gray-600 mb-2">·∫¢nh chi ti·∫øt (T·ªëi ƒëa 5 ·∫£nh)</label>

        <div class="flex flex-wrap gap-3">
          <!-- Preview ·∫£nh gallery -->
          <div *ngFor="let img of previewGallery; let i = index"
            class="relative w-24 h-24 border rounded-lg overflow-hidden">
            <img [src]="img" class="w-full h-full object-cover" />
            <button type="button" (click)="removeGalleryImage(i, $event)"
              class="absolute top-1 right-1 bg-white/90 hover:bg-white text-gray-600 rounded-full p-1">
              <lucide-icon name="x" class="w-3 h-3"></lucide-icon>
            </button>
          </div>

          <!-- N√∫t th√™m ·∫£nh -->
          <div
            class="w-24 h-24 border-2 border-dashed rounded-lg flex flex-col justify-center items-center text-gray-400 cursor-pointer hover:bg-gray-50"
            (click)="fileInputGallery.click()" *ngIf="previewGallery.length < 5">
            <lucide-icon name="plus" class="w-6 h-6 mb-1"></lucide-icon>
            <span class="text-xs">Th√™m</span>
          </div>
        </div>

        <!-- Input ch·ªçn ·∫£nh gallery -->
        <input type="file" hidden multiple #fileInputGallery (change)="onGallerySelected($event)" accept="image/*" />
      </div>
      <!-- S·∫¢N PH·∫®M C√ì BI·∫æN TH·ªÇ -->
      <div class="mt-8 border-t pt-6">
        <div class="flex items-center justify-between mb-4">
          <label class="flex items-center space-x-2 text-sm text-gray-700">
            <input type="checkbox" [(ngModel)]="product.hasVariants" name="hasVariants"
              class="rounded border-gray-300 focus:ring-orange-400" />
            <span>S·∫£n ph·∫©m c√≥ nhi·ªÅu bi·∫øn th·ªÉ</span>
          </label>

          <button *ngIf="product.hasVariants" type="button" (click)="addVariant()"
            class="flex items-center bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded-md text-sm space-x-1">
            <lucide-icon name="plus" class="w-4 h-4"></lucide-icon>
            <span>Th√™m bi·∫øn th·ªÉ</span>
          </button>
        </div>

        <!-- üß© DANH S√ÅCH BI·∫æN TH·ªÇ -->
        <div *ngIf="product.hasVariants && product.variants.length > 0" class="space-y-3">
          <div *ngFor="let v of product.variants; let i = index"
            class="border rounded-xl p-5 bg-white shadow-sm relative transition-all hover:shadow-md">
            <!-- ‚ùå N√∫t x√≥a bi·∫øn th·ªÉ -->
            <button type="button" (click)="removeVariant(i)"
              class="absolute top-2 right-2 bg-white hover:bg-red-100 text-red-500 rounded-full p-1 shadow-sm">
              <lucide-icon name="x" class="w-4 h-4"></lucide-icon>
            </button>

            <!-- üß± Form n·ªôi dung -->
            <div class="grid grid-cols-3 gap-2">
              <!-- T√™n bi·∫øn th·ªÉ -->
              <div>
                <label class="block text-xs text-gray-600 mb-1">T√™n bi·∫øn th·ªÉ</label>
                <input type="text" [(ngModel)]="v.name" name="variant_name_{{ i }}" placeholder="VD: ƒê·∫∑t s√†n AT6480"
                  class="w-full border rounded-md px-3 py-2 text-sm focus:ring-1 focus:ring-orange-400" />
              </div>

              <!-- SKU -->
              <div>
                <label class="block text-xs text-gray-600 mb-1">SKU</label>
                <input type="text" [(ngModel)]="v.sku" name="variant_sku_{{ i }}" placeholder="VD: AT6480"
                  class="w-full border rounded-md px-3 py-2 text-sm focus:ring-1 focus:ring-orange-400" />
              </div>

              <!-- Gi√° -->
              <div>
                <label class="block text-xs text-gray-600 mb-1">Gi√° (VND)</label>
                <!-- <input type="number" [(ngModel)]="v.price" name="variant_price_{{ i }}" placeholder="Gi√° g·ªëc"
                  class="w-full border rounded-md px-3 py-2 text-sm focus:ring-1 focus:ring-orange-400" /> -->
                <input type="text" [ngModel]="formatPrice(v.price)"
                  (ngModelChange)="onVariantPriceChange($event, v, 'price')" name="variant_price_{{ i }}"
                  placeholder="Gi√° g·ªëc"
                  class="w-full border rounded-md px-3 py-2 text-sm focus:ring-1 focus:ring-orange-400" />
              </div>

              <!-- Gi√° khuy·∫øn m√£i -->
              <div>
                <label class="block text-xs text-gray-600 mb-1">Gi√° khuy·∫øn m√£i</label>
                <input type="text" [ngModel]="formatPrice(v.salePrice)"
                  (ngModelChange)="onVariantPriceChange($event, v, 'salePrice')" name="variant_salePrice_{{ i }}"
                  placeholder="Gi√° khuy·∫øn m√£i"
                  class="w-full border rounded-md px-3 py-2 text-sm focus:ring-1 focus:ring-orange-400" />
              </div>

              <!-- T·ªìn kho -->
              <div>
                <label class="block text-xs text-gray-600 mb-1">T·ªìn kho</label>
                <input type="number" [(ngModel)]="v.stockQuantity" name="variant_stock_{{ i }}" placeholder="S·ªë l∆∞·ª£ng"
                  class="w-full border rounded-md px-3 py-2 text-sm focus:ring-1 focus:ring-orange-400" />
              </div>


              <!-- ‚úÖ ·∫¢NH BI·∫æN TH·ªÇ -->
              <div class="col-span-3">
                <label class="block text-xs text-gray-600 mb-2">·∫¢nh bi·∫øn th·ªÉ</label>

                <div class="flex flex-wrap gap-3">
                  <!-- N·∫øu c√≥ ·∫£nh -->
                  <div *ngIf="v.variantImgUrl" class="relative w-24 h-24 border rounded-lg overflow-hidden shadow-sm">
                    <img [src]="v.variantImgUrl" alt="·∫¢nh bi·∫øn th·ªÉ" class="w-full h-full object-cover" />
                    <button type="button" (click)="removeVariantImage(i)"
                      class="absolute top-1 right-1 bg-white/90 hover:bg-white text-gray-600 rounded-full p-1">
                      <lucide-icon name="x" class="w-3 h-3"></lucide-icon>
                    </button>
                  </div>

                  <!-- N·∫øu ch∆∞a c√≥ ·∫£nh -->
                  <div *ngIf="!v.variantImgUrl"
                    class="w-24 h-24 border-2 border-dashed rounded-lg flex flex-col justify-center items-center text-gray-400 cursor-pointer hover:bg-gray-50"
                    (click)="variantFileInputs.toArray()[i].nativeElement.click()">
                    <lucide-icon name="plus" class="w-6 h-6 mb-1"></lucide-icon>
                    <span class="text-xs">Th√™m</span>
                  </div>
                </div>

                <!-- Input file ·∫©n -->
                <input type="file" accept="image/*" #variantFileInput (change)="onVariantImageChange($event, i)"
                  hidden />
              </div>
            </div>
          </div>
        </div>

      </div>

    </div>


    <!-- N√∫t -->
    <div class="col-span-3 flex justify-end gap-3 mt-6">
      <button type="button" (click)="goBack()"
        class="px-4 py-2 border rounded-md text-sm text-gray-600 hover:bg-gray-100">
        H·ªßy
      </button>
      <button type="submit" class="px-4 py-2 bg-[#3AA7E9] hover:bg-[#00456F] text-white rounded-md text-sm">
        L∆∞u
      </button>
    </div>
  </form>

</div>